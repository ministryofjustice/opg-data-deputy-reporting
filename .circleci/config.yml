---
version: 2.1

workflows:
  pull_request:
    jobs:
      - build_lambda:
          name: python requirements
          filters: {branches:{ignore:[master]}}
      - terraform_pre_checks:
          name: terraform development preflight checks
          requires: [python requirements]
          filters: {branches:{ignore:[master]}}
      - terraform_action:
          filters: {branches:{ignore:[master]}}
          name: plan development environment
          requires: [python requirements, terraform development preflight checks]
          tf_command: plan
# commit_to_master:
#   jobs:
#     - build_lambda:
#         name: python requirements
#         filters: { branches: { only: [ master ] } }
#     - terraform_pre_checks:
#         name: terraform preprod preflight checks
#         filters: { branches: { only: [ master ] } }
#         requires: [python requirements]
#     - terraform_action:
#         name: preprod apply
#         filters: { branches: { only: [ master ] } }
#         requires: [terraform preprod preflight checks]
#         tf_command: apply --auto-approve
#         tf_workspace: preproduction
#     - approve:
#         name: approve release to production
#         type: approval
#         requires: [ preprod apply ]
#         filters: { branches: { only: [ master ] } }
# - terraform_pre_checks:
#     name: terraform prod preflight checks
#     filters: { branches: { only: [ master ] } }
#     requires: [approve release to production]
#     tf_workspace: production
# - terraform_action:
#     name: production apply
#     filters: { branches: { only: [ master ] } }
#     requires: [terraform prod preflight checks]
#     tf_command: apply
#     tf_workspace: production

orbs:
  digideps-data:
    executors:
      python_with_tfvars:
        docker:
          - image: circleci/python:3.8.1
        environment:
          TF_VERSION: 0.12.19
          TF_SHA256SUM: a549486112f5350075fb540cfd873deb970a9baf8a028a86ee7b4472fc91e167
          TF_CLI_ARGS_plan: -input=false -lock=false
          TF_CLI_ARGS_apply: -input=false -auto-approve
          TF_CLI_ARGS_destroy: -input=false -auto-approve
          TF_CLI_ARGS_init: -input=false -upgrade=true -reconfigure
          TF_VAR_default_role: sirius-ci
      python:
        docker:
          - image: circleci/python:3.8.1
    commands:
      terraform_install:
        steps:
          - run:
              name: Download Terraform
              command: curl -sfSO https://releases.hashicorp.com/terraform/${TF_VERSION}/terraform_${TF_VERSION}_linux_amd64.zip
          - run:
              name: Add Terraform SHA256SUM
              command: echo "${TF_SHA256SUM} terraform_${TF_VERSION}_linux_amd64.zip" > SHA256SUMS
          - run:
              name: Check Terraform SHA256SUM
              command: sha256sum -c --status SHA256SUMS
          - run:
              name: Install Terraform
              command: sudo unzip terraform_${TF_VERSION}_linux_amd64.zip -d /bin

jobs:
  build_lambda:
    executor: digideps-data/python
    steps:
      - checkout
      - run:
          name: install python validation packages
          command: |
            pip3 install flake8 yamllint pycodestyle
      - run:
          name: validate python packages
          command: |
            cd ./lambda
            yamllint -d "{extends: default, rules: {line-length: {max: 150}}}" .
            pycodestyle .
            flake8 .
      - run: pip3 install -r ./lambda/requirements.txt  --target ./lambda
      - run: chmod -R 755 ./lambda
      - run: zip -r9 /tmp/opg-data-deputy-reporting.zip .
      - persist_to_workspace:
          root: /tmp
          paths:
            - opg-data-deputy-reporting.zip
  terraform_pre_checks:
    executor: digideps-data/python_with_tfvars
    parameters:
      tf_workspace:
        description: terraform workspace
        type: string
        default: ""
    working_directory: ~/project
    steps:
      - attach_workspace:
          at: ~/project
      - run:
          name: check some stuff
          command: pwd; ls -alt ~/project;
      - digideps-data/terraform_install
      - run:
          name: check some stuff
          command: pwd; ls -alt ~/project;
      - run:
          name: unzip artifact
          command: unzip ./opg-data-deputy-reporting.zip -d .
      - run:
          name: initialize
          command: cd ./terraform; terraform init
      - run:
          name: terraform format check
          command: cd ./terraform; terraform fmt -diff -check -recursive
      - run:
          name: terraform validate
          command: cd ./terraform; terraform validate
  terraform_action:
    executor: digideps-data/python_with_tfvars
    parameters:
      tf_workspace:
        description: terraform workspace
        type: string
        default: ""
      tf_command:
        description: terraform command
        default: plan
        type: string
    environment:
      WORKSPACE: << parameters.tf_workspace >>
    working_directory: ~/project
    steps:
      - attach_workspace:
          at: ~/project
      - digideps-data/terraform_install
      - run:
          name: unzip artifact
          command: unzip ./opg-data-deputy-reporting.zip -d .
      - run:
          name: initialize
          command: cd ./terraform; terraform init
      - run:
          name: set environment
          command: ~/project/.circleci/set_env.sh >> $BASH_ENV
      - run:
          name: Set Environment variable
          command: |
            `cat $BASH_ENV | grep TF_WORKSPACE`
      - run:
          name: terraform << parameters.tf_command >>
          command: cd ./terraform; terraform << parameters.tf_command >>
